
@{
    ViewBag.Title = "GigFeedbackReview";
    Layout = Layout;
}
@model dynamic
<div class="largebox_content_containerbg">
    <div class="container">


        <div class="container_inner middile_con_inner_bg clearfix" id="divcontent">
            <div id="loaderDiv" class="loaderDivclass " style="display:none"></div>
            @if (Model != null)
            {
                <div class="col-md-12 home_con_top_search_bg home_con_top_search_bg_admin bg_color_comen clearfix">
                    <!-- /input-group -->
                    <div class="col-md-12 catagory_con_top_bg job_review_sortbg_bg">

                        <div class="pull-right ">
                            <div class="category_sort_by_bg form-group clearfix">
                                <div>
                                    <label for="" class="">Sort by:</label>
                                    <select id="ddlSort" class="form-control">
                                        <option value="N">Newest</option>
                                        <option value="O">Oldest</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-12 con_8_4_outer_bg clearfix">
                    <div class="col-md-12 home_user_box_1_bg bg_color_comen padd_left_right_o clearfix">
                        <div id="divjobs" class="gig_review_all_bg clearfix">                            
                            @foreach (var item in Model)
                            {
                                <div class="box_paddleftright_15 clearfix">
                                    <div class="client_profile_imgname_bg clearfix">
                                        <div class="pull-left">
                                            <div class="client_profile_pic">
                                                <div class="client_profile_pic_1">
                                                    <img src="@item.ProfilePic" alt="">
                                                </div>
                                                <i class="profile_pic_star"></i>
                                            </div>
                                            <div class="client_profile_name">
                                                <a href="javascript:;">
                                                    <h4>@item.FullName</h4>
                                                </a>
                                                <span>@item.CreatedDateDisplay</span>
                                            </div>
                                        </div><!--pull-left-->
                                        <div class="pull-right text-right">
                                            <div class="company_profile_refedit">
                                                <input type="hidden" id="hfgigreviewid_@item.GigReviewId" value="@item.GigReviewId" />
                                                <div class="profile_public_banner_rate_only">
                                                    <ul class="clearfix">
                                                        @if (item.JobSeekerRatingInt == 1)
                                                        {
                                                            <li><i></i></li>
                                                                        <li class="star_gray"><i></i></li>
                                                                        <li class="star_gray"><i></i></li>
                                                                        <li class="star_gray"><i></i></li>
                                                                        <li class="star_gray"><i></i></li>
                                                        }
                                                        else if (item.JobSeekerRatingInt == 2)
                                                        {
                                                            <li><i></i></li>
                                                                        <li><i></i></li>
                                                                        <li class="star_gray"><i></i></li>
                                                                        <li class="star_gray"><i></i></li>
                                                                        <li class="star_gray"><i></i></li>
                                                        }
                                                        else if (item.JobSeekerRatingInt == 3)
                                                        {
                                                            <li><i></i></li>
                                                                        <li><i></i></li>
                                                                        <li><i></i></li>
                                                                        <li class="star_gray"><i></i></li>
                                                                        <li class="star_gray"><i></i></li>
                                                        }
                                                        else if (item.JobSeekerRatingInt == 4)
                                                        {
                                                            <li><i></i></li>
                                                                        <li><i></i></li>
                                                                        <li><i></i></li>
                                                                        <li><i></i></li>
                                                                        <li class="star_gray"><i></i></li>
                                                        }
                                                        else if (item.JobSeekerRatingInt == 5)
                                                        {
                                                            <li><i></i></li>
                                                                        <li><i></i></li>
                                                                        <li><i></i></li>
                                                                        <li><i></i></li>
                                                                        <li><i></i></li>
                                                        }

                                                    </ul>

                                                </div>
                                            </div>
                                        </div><!--pull-right-->
                                    </div>
                                    <div class="col-md-12 home_client_discription_small clearfix">
                                        <div class="readmoretext more">@item.Review</div>

                                    </div>
                                    <div class="pull-right text-right">
                                        <div class="company_profile_refedit">
                                            <input type="hidden" id="hfgigid_@item.GigReviewId" value="@item.GigReviewId" />
                                            <input type="hidden" id="hfposterid_@item.UserId" value="@item.UserId" />
                                            <input type="hidden" id="hfpostername_@item.FullName" value="@item.FullName" />
                                            <input type="hidden" id="hfgigtitle_@item.GigTitle" value="@item.GigTitle" /> 
                                            <input type="hidden" id="hfgigposteremail_@item.Email" value="@item.Email" />
                                            <input type="hidden" id="hfgigcreateddate_@item.CreatedDateDisplay" value="@item.CreatedDateDisplay" />                                                               
                                                <a href="#" class="btn button_all secondary_color_2_bg job_review_app_reg apprv" title="Approve"><i class="fa fa-check-circle"></i><span>Approve</span></a>
                                                <a href="#" class="btn button_all secondary_color_bg job_review_app_reg rjct" title="Reject"><i class="fa fa-times-circle" aria-hidden="true"></i><span>Reject</span></a>
                                            </div>
                                    </div>                                   
                                </div><!--box_paddleftright_15-->                                
                            }                            
                        </div><!--gig_review_all_bg-->
                    </div>

                </div>
                <div id="loadMore">
                    @if (Model != null && Model.Count > 0 && Model[0].Isloadmore == 1)
                    {
                        <div class="col-md-12 category_loadmore_bg clearfix" id="divloadmore">
                            <a href="javascript:;" class="btn button_all secondary_color_bg" id="btnloadmore">Load more</a>
                        </div>
                    }
                </div>
            }
        </div>
    </div>
</div>

<!--===============Manage Jobs Popup Section================= -->
@*Approve job confirmation - admin*@
<div id="gigreviewapproveadmin" class="popup_box clearfix myshadow">
    <span id="" class="col-md-12 popup_box_title clearfix">Approve Service Review<a href="javascript:;" onclick="closebox('gigreviewapproveadmin')" class="popup_close_bg" title="Close"></a> </span>
    <div class="col-md-12 pop_container_bg text-center">
        <div class="form-group clearfix">
            <label for="" class="input_label_style">Are you sure to approve the service review for <span class="" id="spanadminapprovegig"></span></label>
            <a href="#" id="btnAdminGigReviewApprove" class="btn btn_banner secondary_color_bg maxwidth325" title="Approve Service Review">Approve Service Review</a>
        </div>
        <div class="form-group register_small_already_reg delete_job_link clearfix">
            <p><a href="javascript:;" onclick="closebox('gigreviewapproveadmin')">Cancel</a></p>
        </div>
    </div>
</div>

@*Reject job - reason pick*@
<div id="popup_rejectreview" class="popup_box clearfix myshadow">
    <span id="" class="col-md-12 popup_box_title clearfix">Reject Service Review <a href="javascript:;" onclick="closebox('popup_rejectreview')" class="popup_close_bg" title="Close"></a> </span>
    <div class="col-md-12 pop_container_bg text-center">
        <div class="form-group clearfix">
            <label for="" class="input_label_style">Are you sure to reject the service review for <span class="" id="spanadminrejectgigreview"></span></label>            
            <a href="#" id="btnRejectGigReviewAdmin" class="btn btn_banner secondary_color_bg maxwidth325" title="Reject Service Review">Reject Service Review</a>
        </div>
        <div class="form-group register_small_already_reg delete_job_link clearfix">
            <p><a href="javascript:;" onclick="closebox('popup_rejectreview')">Cancel</a></p>
        </div>
    </div>
</div>
<script src="~/Scripts/jquery.signalR-2.3.0.min.js"></script>
<script src="~/signalr/hubs"></script>
<script type="text/javascript">
    $(document).ready(function () {
        $("#pageTitle").text("Approve user reviews")
        var showChar = 100;
        var ellipsestext = "...";
        var moretext = "Read More";
        var lesstext = "Read less";
        $('.more').each(function () {
            var content = $(this).html();

            if (content.length > showChar) {

                var c = content.substr(0, showChar);
                var h = content.substr(showChar - 1, content.length - showChar);

                var html = c + '<span class="moreellipses">' + ellipsestext + '&nbsp;</span><span class="morecontent"><span>' + h + '</span>&nbsp;&nbsp;<a href="#" class="morelink">' + moretext + '</a></span>';

                $(this).html(html);
            }

        });

        $("#divjobs").on("click", ".morelink", function () {
            if ($(this).hasClass("less")) {
                $(this).removeClass("less");
                $(this).html(moretext);
            } else {
                $(this).addClass("less");
                $(this).html(lesstext);
            }
            $(this).parent().prev().toggle();
            $(this).prev().toggle();
            return false;
        });

        $("#loadMore").on("click", " #btnloadmore", function (e) {
            debugger;
            var _Id = $('div.company_profile_refedit').last().find('input[id^="hfgigid_"]').val();
            LoadMore(_Id);
            e.preventDefault();
        });
        function LoadMore(id) {
            debugger;
            var _SortBy = $("#ddlSort").val();
            $.ajax({
                type: 'POST',
                cache: false,
                url: '@Url.Action("LoadMoreGigReview", "Admin")',
                data: {
                    'id': id,
                    "SortBy": _SortBy
                },
                success: function (response) {
                    $("#divloadmore").remove();
                    genaratehtml(response);
                },
                error: function (jqXHR, exception) {
                    console.log(jqXHR.status);
                    console.log(exception);
                }
            });
        }

        $("#divjobs").on("click", "a.apprv", function () {
            debugger;
            var _gigreviewid = $(this).closest('div.company_profile_refedit').find('input[id^="hfgigid_"]').val();
            var _gigtitledispaly = $(this).closest('div.company_profile_refedit').find('input[id^="hfgigtitle_"]').val();
            var _gigposter = $(this).closest('div.company_profile_refedit').find('input[id^="hfpostername_"]').val();
            $("#spanadminapprovegig").html(" <b>" + _gigtitledispaly + "</b> posted by <b> " + _gigposter + "</b>");


            $("#hfgigpostername").val(_gigposter);
            $("#hfgigreviewidpop").val(_gigreviewid);
            var _gigposteridpop = $(this).closest('div.company_profile_refedit').find('input[id^="hfposterid_"]').val();
            var _gigposteremailpop = $(this).closest('div.company_profile_refedit').find('input[id^="hfgigposteremail_"]').val();
            var _gigcreateddatepop = $(this).closest('div.company_profile_refedit').find('input[id^="hfgigcreateddate_"]').val();

            $("#hfgigposteridpop").val(_gigposteridpop)
            $("#hfgigposteremailpop").val(_gigposteremailpop)
            $("#hfgigcreateddatepop").val(_gigcreateddatepop)
            $("#hfgigtitlepop").val(_gigtitledispaly)



            openbox(1, 'gigreviewapproveadmin');
        });

        $("#divjobs").on("click", "a.rjct", function () {
            debugger;
            var _gigreviewid = $(this).closest('div.company_profile_refedit').find('input[id^="hfgigid_"]').val();
            var _gigtitledispaly = $(this).closest('div.company_profile_refedit').find('input[id^="hfgigtitle_"]').val();
            var _gigposter = $(this).closest('div.company_profile_refedit').find('input[id^="hfpostername_"]').val();
            $("#spanadminrejectgigreview").html(" <b>" + _gigtitledispaly + "</b> posted by <b>" + _gigposter + "</b>");


            var _gigposteridpop = $(this).closest('div.company_profile_refedit').find('input[id^="hfposterid_"]').val();
            var _gigposteremailpop = $(this).closest('div.company_profile_refedit').find('input[id^="hfgigposteremail_"]').val();
            var _gigcreateddatepop = $(this).closest('div.company_profile_refedit').find('input[id^="hfgigcreateddate_"]').val();

            $("#hfgigpostername").val(_gigposter);
            $("#hfgigreviewidpop").val(_gigreviewid);
            $("#hfgigposteridpop").val(_gigposteridpop)
            $("#hfgigposteremailpop").val(_gigposteremailpop)
            $("#hfgigcreateddatepop").val(_gigcreateddatepop)
            $("#hfgigtitlepop").val(_gigtitledispaly)

            openbox(1, 'popup_rejectreview');
        });

        $("#btnAdminGigReviewApprove").click(function()
        {
            debugger;
            var _GigReviewid = $("#hfgigreviewidpop").val();
            var _PosterId = $("#hfgigposteridpop").val();
            var _PosterName = $('#hfgigpostername').val();
            var _Email = $("#hfgigposteremailpop").val();
            var _AdminUserId = @Session["UserId"];
            var _GigTitle = $("#hfgigtitlepop").val();
            var _GigCreatedDate = $("#hfgigcreateddatepop").val();

            $.ajax({
                url: '@Url.Action("GigFeedbackReviewProcess", "Admin")',
                data: {
                    "GigReviewid": _GigReviewid,
                    "UserId": _PosterId,
                    "Email": _Email,
                    "RejectionReason": 0,
                    "AdminUserId": _AdminUserId,
                    "GigTitle":_GigTitle,
                    "CreatedDateDisplay":_GigCreatedDate
                },
                beforeSend: function() {
                    $("#loaderDiv").show();
                },
                type: "POST",
                success: function (response) {
                    debugger
                    $("#loaderDiv").hide();
                    if(response == "Success")
                    {

                        var notification = $.connection.notificationHub;
                        var _notification = "Your review for service " + _GigTitle + " has been approved";
                        var _header = "Service review approved";
                        $.connection.hub.start().done(function () {
                            notification.server.send(_AdminUserId, _PosterId, _PosterName, _notification, _header, ' ');
                        }).fail(function(){ console.log('Could not connect'); });
                        closebox("gigreviewapproveadmin");
                        window.location="/Admin/GigFeedbackReview";
                    }
                },
                error: function () {
                    $("#loaderDiv").hide();
                }
            });

        });

        $("#btnRejectGigReviewAdmin").click(function()
        {
            var _GigReviewid = $("#hfgigreviewidpop").val();
            var _PosterId = $("#hfgigposteridpop").val();
            var _PosterName = $('#hfgigpostername').val();
            var _Email = $("#hfgigposteremailpop").val();
            var _AdminUserId = @Session["UserId"];
            var _GigTitle = $("#hfgigtitlepop").val();
            var _GigCreatedDate = $("#hfgigcreateddatepop").val();

           
            $("#errorMsgRejectReason").empty();
            $.ajax({
                url: '@Url.Action("GigFeedbackReviewProcess", "Admin")',
                data: {
                    "GigReviewid": _GigReviewid,
                    "UserId": _PosterId,
                    "Email": _Email,
                    "RejectionReason": 1,
                    "AdminUserId": _AdminUserId,
                    "GigTitle":_GigTitle,
                    "CreatedDateDisplay":_GigCreatedDate
                },
                type: "POST",
                success: function (response) {
                    if(response == "Success")
                    {
                        var notification = $.connection.notificationHub;
                        var _notification = "Your review for service " + _GigTitle + " has been rejected";
                        var _header = "Service Review Rejected";
                        //notification.server.send(_AdminUserId, _PosterId, _PosterName, _notification, _header,'');
                        $.connection.hub.start().done(function () {
                            notification.server.send(_AdminUserId, _PosterId, _PosterName, _notification, _header, ' ');
                        }).fail(function(){ console.log('Could not connect'); });
                        closebox("popup_rejectreview");
                        window.location="/Admin/GigFeedbackReview";
                    }
                },
                error: function () {

                }
            });
        });

        $("#ddlSort").change(function () {
            debugger;
            var _SortBy = $("#ddlSort").val();
            GigFeedbackReviewFilter(_SortBy);
        });

        function GigFeedbackReviewFilter(_SortBy)
        {            
            $.ajax({
                url: '@Url.Action("GigFeedbackReviewFilter", "Admin")',
                data: {                    
                    "SortBy": _SortBy
                },
                type: "POST",
                success: function (response) {
                    $("#divjobs").empty();
                    $("#divloadmore").remove();
                    if(response != "Failed") {
                        genaratehtml(response);

                    } else {
                        $("#divjobs").append('<div class="nojob_diplytable" id="divmsg"><div class="col-md-12 category_nojob_bg clearfix"><h3>There don\'t seem to be any services matching this search criterion.</h3></div></div>');
                    }
                },
                error: function () {

                }
            });
        }
    })
    function genaratehtml(response) {
        $.each(response, function (key, value) {
            var elem = " ";
            elem = "<div class='box_paddleftright_15 clearfix'>";
            elem = elem + "<div class='client_profile_imgname_bg clearfix'>";
            elem = elem + "<div class='pull-left'>";
            elem = elem + "<div class='client_profile_pic'>";
            elem = elem + "<div class='client_profile_pic_1'>";
            elem = elem + "<img src='" + response[key].ProfilePic + "' alt='' />";
            elem = elem + "</div>";
            elem = elem + "<i class='profile_pic_star'></i>";
            elem = elem + "</div>";
            elem = elem + "<div class='client_profile_name'>";
            var _href = "javascript:;";
            elem = elem + "<a href=" + _href + " style='cursor:default;'><h4>" + response[key].FullName + "</h4></a>";
            elem = elem + "<span>" + response[key].CreatedDateDisplay + "</span>";
            elem = elem + "</div>";
            elem = elem + "</div>";
            elem = elem + "<div class='pull-right text-right'>";
            elem = elem + "<div class='company_profile_refedit'>";
            elem = elem + "<div class='profile_public_banner_rate_only'>";

            elem = elem + "<ul class='clearfix'>";
            if (response[key].JobSeekerRatingInt == 1) {
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li class='star_gray'><i></i></li>";
                elem = elem + "<li class='star_gray'><i></i></li>";
                elem = elem + "<li class='star_gray'><i></i></li>";
                elem = elem + "<li class='star_gray'><i></i></li>";
            }
            else if (response[key].JobSeekerRatingInt == 2) {
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li class='star_gray'><i></i></li>";
                elem = elem + "<li class='star_gray'><i></i></li>";
                elem = elem + "<li class='star_gray'><i></i></li>";
            }
            else if (response[key].JobSeekerRatingInt == 3) {
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li class='star_gray'><i></i></li>";
                elem = elem + "<li class='star_gray'><i></i></li>";
            }
            else if (response[key].JobSeekerRatingInt == 4) {
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li class='star_gray'><i></i></li>";
            }
            else if (response[key].JobSeekerRatingInt == 5) {
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li><i></i></li>";
                elem = elem + "<li><i></i></li>";
            }
            elem = elem + "</ul>";
            elem = elem + "</div>";
            elem = elem + "</div>";
            elem = elem + "</div>";
            elem = elem + "</div>";
            elem = elem + "<div class='col-md-12 home_client_discription_small clearfix'>";
            elem = elem + "<div class='readmoretext more'>" + response[key].Review + "</div>";
            elem = elem + "</div>";
            elem = elem + "<div class='pull-right text-right'>";
            elem = elem + "<div class='company_profile_refedit'>";
            var hfgigid_ = "hfgigid_" + response[key].GigReviewId;
            elem = elem + "<input type='hidden' id=" + hfgigid_ + " value=" + response[key].GigReviewId + " />";
            var hfposterid_ = "hfposterid_" + response[key].UserId;
            elem = elem + "<input type='hidden' id=" + hfposterid_ + " value=" + response[key].UserId + " />";
            var hfpostername_ = "hfpostername_" + response[key].FullName;
            elem = elem + "<input type='hidden' id=" + hfpostername_ + " value=" + response[key].FullName + " />";
            var hfgigtitle_ = "hfgigtitle_" + response[key].GigTitle;
            elem = elem + "<input type='hidden' id=" + hfgigtitle_ + " value=" + response[key].GigTitle + " />";
            var hfgigposteremail_ = "hfgigposteremail_" + response[key].Email;
            elem = elem + "<input type='hidden' id=" + hfgigposteremail_ + " value=" + response[key].Email + " />";
            var hfgigcreateddate_ = "hfgigcreateddate_" + response[key].CreatedDateDisplay;
            elem = elem + "<input type='hidden' id=" + hfgigcreateddate_ + " value=" + response[key].CreatedDateDisplay + " />";
            elem = elem + "<a href='#' class='btn button_all secondary_color_2_bg job_review_app_reg apprv' title='Approve'><i class='fa fa-check-circle'></i><span>Approve</span></a>";
            elem = elem + "<a href='#' class='btn button_all secondary_color_bg job_review_app_reg rjct' title='Reject'><i class='fa fa-times-circle' aria-hidden='true'></i><span>Reject</span></a>";
            elem = elem + "</div>";
            elem = elem + "</div>";
            elem = elem + "</div>";
            $("#divjobs").append(elem);
            elem = " ";
        })

        var showChar = 100;
        var ellipsestext = "...";
        var moretext = "Read More";
        var lesstext = "Read less";
        $('.more').each(function () {
            debugger;
            var content = $(this).html();
            var _text = $($.parseHTML(content)).filter('.moreellipses').text();
            if (_text == "") {
                if (content.length > showChar) {
                    var c = content.substr(0, showChar);
                    var h = content.substr(showChar - 1, content.length - showChar);
                    var html = c + '<span class="moreellipses">' + ellipsestext + '&nbsp;</span><span class="morecontent"><span>' + h + '</span>&nbsp;&nbsp;<a href="#" class="morelink">' + moretext + '</a></span>';
                    $(this).html(html);
                }
            }


        });
        var _morebutton = response[0].Isloadmore;
        if (_morebutton == 1) {
            var _elment2 = " ";
            _elment2 = _elment2 + "<div class='col-md-12 category_loadmore_bg clearfix' id='divloadmore'>";
            _elment2 = _elment2 + " <a href='javascript:' class='btn button_all secondary_color_bg' id='btnloadmore'>Load more</a></div></div>";
            $("#loadMore").append(_elment2)
        }
    }

</script>
<input type="hidden" id="hfgigreviewidpop" />
<input type="hidden" id="hfgigposteridpop" />
<input type="hidden" id="hfgigpostername" />
<input type="hidden" id="hfgigposteremailpop" />
<input type="hidden" id="hfgigtitlepop" />
<input type="hidden" id="hfgigcreateddatepop" />